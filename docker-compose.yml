services:
  web:
    build: ./web
    volumes:
      - /var/www/aresbotv3:/app/dist
    # 构建完成后退出，不需要持续运行
    restart: "no"

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    ports:
      - "${OAUTH2_PROXY_PORT:-44180}:4180"
    environment:
      # OAuth2 Provider 配置 (GitHub)
      - OAUTH2_PROXY_PROVIDER=github
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_PROXY_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_PROXY_CLIENT_SECRET}
      # Cookie 配置
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_DOMAINS=${OAUTH2_PROXY_COOKIE_DOMAIN}
      # 上游服务配置
      - OAUTH2_PROXY_UPSTREAMS=http://api:8000/
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      # 邮箱白名单 (只允许指定邮箱登录)
      - OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE=/etc/oauth2-proxy/authenticated-emails.txt
      # 其他配置
      - OAUTH2_PROXY_REDIRECT_URL=https://${OAUTH2_PROXY_DOMAIN}/oauth2/callback
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_PASS_USER_HEADERS=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=false
      - OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=true
    volumes:
      - ./oauth2-proxy/authenticated-emails.txt:/etc/oauth2-proxy/authenticated-emails.txt:ro
    networks:
      - default
    depends_on:
      - api
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    ports:
      - "${API_PORT:-48000}:8000"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=${MYSQL_USER:-aresbot}
      - DB_PASSWORD=${MYSQL_PASSWORD:-aresbot}
      - DB_NAME=${MYSQL_DATABASE:-aresbot}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
    networks:
      - default
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    volumes:
      - /app/data/aresbotWorker:/app/data/worker
      - /app/data/aresbotWorker/logs:/app/logs   # 日志目录
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=${MYSQL_USER:-aresbot}
      - DB_PASSWORD=${MYSQL_PASSWORD:-aresbot}
      - DB_NAME=${MYSQL_DATABASE:-aresbot}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/0
      - WORKER_NAME_FILE=/app/data/worker/worker_name
      - WORKER_NAME_PREFIX=${WORKER_NAME_PREFIX:-celery@worker}
      - WORKER_NODE_ID=${WORKER_NODE_ID:-}
      - CELERY_LOG_LEVEL=${CELERY_LOG_LEVEL:-info}
    networks:
      - default
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      replicas: ${WORKER_REPLICAS:-2}
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    ports:
      - "${REDIS_PORT:-46379}:6379"
    networks:
      - default
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  mysql:
    image: mysql:8
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-aresbot}
      - MYSQL_USER=${MYSQL_USER:-aresbot}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-aresbot}
    ports:
      - "${MYSQL_PORT:-43306}:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - default
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped
