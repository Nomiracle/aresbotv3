services:
  celery-worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    volumes:
      - ${WORKER_DATA_DIR:-/app/data/aresbotWorker}:/app/data/worker
      - ${WORKER_LOG_DIR:-/app/data/aresbotWorker/logs}:/app/logs
    environment:
      - TZ=${CONTAINER_TZ:-Asia/Shanghai}
      - DB_HOST=${MASTER_HOST}
      - DB_PORT=${MASTER_MYSQL_PORT:-43306}
      - DB_USER=${MYSQL_USER:-aresbot}
      - DB_PASSWORD=${MYSQL_PASSWORD:-aresbot}
      - DB_NAME=${MYSQL_DATABASE:-aresbot}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      - REDIS_HOST=${MASTER_HOST}
      - REDIS_PORT=${MASTER_REDIS_PORT:-46379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_CONNECT_TIMEOUT=${REDIS_CONNECT_TIMEOUT:-1.0}
      - REDIS_SOCKET_TIMEOUT=${REDIS_SOCKET_TIMEOUT:-1.0}

      - WORKER_NAME_FILE=/app/data/worker/worker_name
      - WORKER_NAME_PREFIX=${WORKER_NAME_PREFIX:-celery@worker}
      - WORKER_NODE_ID=${WORKER_NODE_ID:-}
      - CELERY_LOG_LEVEL=${CELERY_LOG_LEVEL:-info}
      - CELERY_CONCURRENCY=${CELERY_CONCURRENCY:-4}
      - CELERY_POOL=${CELERY_POOL:-threads}
      - STRATEGY_STOP_POLL_INTERVAL=${STRATEGY_STOP_POLL_INTERVAL:-0.8}
      - WORKER_LOG_DIR=/app/logs
    deploy:
      replicas: ${WORKER_REPLICAS:-1}
    restart: unless-stopped
