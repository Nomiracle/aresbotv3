# 工作节点配置 - 只运行 Celery Worker
# 连接主节点的 MySQL 和 Redis

services:
  worker:
    build: .
    command: celery -A celery_app worker --loglevel=${CELERY_LOG_LEVEL:-info} --concurrency=${CELERY_CONCURRENCY:-4} --hostname=worker@%h
    environment:
      # 连接主节点的 MySQL
      - DB_HOST=${MASTER_HOST}
      - DB_PORT=${MASTER_MYSQL_PORT:-43306}
      - DB_USER=${MYSQL_USER:-aresbot}
      - DB_PASSWORD=${MYSQL_PASSWORD:-aresbot}
      - DB_NAME=${MYSQL_DATABASE:-aresbot}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      # 连接主节点的 Redis
      - REDIS_HOST=${MASTER_HOST}
      - REDIS_PORT=${MASTER_REDIS_PORT:-46379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@${MASTER_HOST}:${MASTER_REDIS_PORT:-46379}/0
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@${MASTER_HOST}:${MASTER_REDIS_PORT:-46379}/0
    deploy:
      replicas: ${WORKER_REPLICAS:-4}
    restart: unless-stopped
